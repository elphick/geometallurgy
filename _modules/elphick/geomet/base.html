<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>elphick.geomet.base &mdash; geometallurgy  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=1a8b2067" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            geometallurgy
          </a>
              <div class="version">
                0.4.13
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scope/scope.html">Project Scope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/examples/index.html">Example Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../todo.html">To Do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license/license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">geometallurgy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">elphick.geomet.base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for elphick.geomet.base</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">elphick.geomet.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_yaml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">elphick.geomet.utils.components</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_components</span><span class="p">,</span> <span class="n">is_compositional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">elphick.geomet.utils.moisture</span><span class="w"> </span><span class="kn">import</span> <span class="n">solve_mass_moisture</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">elphick.geomet.utils.pandas</span><span class="w"> </span><span class="kn">import</span> <span class="n">mass_to_composition</span><span class="p">,</span> <span class="n">composition_to_mass</span><span class="p">,</span> <span class="n">composition_factors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">elphick.geomet.utils.timer</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_timer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.config.config_read</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_column_config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">parallel_plot</span><span class="p">,</span> <span class="n">comparison_plot</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">elphick.geomet.flowsheet.stream</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stream</span>

<span class="c1"># generic type variable, used for type hinting, to indicate that the type is a subclass of MassComposition</span>
<span class="n">MC</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;MC&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;MassComposition&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="filter_kwargs">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.filter_kwargs.html#elphick.geomet.base.filter_kwargs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">filter_kwargs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">valid_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_params</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="MassComposition">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MassComposition</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<div class="viewcode-block" id="MassComposition.__init__">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">moisture_in_scope</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">mass_wet_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">mass_dry_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">moisture_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">component_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">composition_units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;ppm&#39;</span><span class="p">,</span> <span class="s1">&#39;ppb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>
                 <span class="n">components_as_symbols</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">ranges</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">config_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The input data</span>
<span class="sd">            name: The name of the sample</span>
<span class="sd">            moisture_in_scope: Whether the moisture is in scope.  If False, only dry mass is processed.</span>
<span class="sd">            mass_wet_var: The name of the wet mass column</span>
<span class="sd">            mass_dry_var: The name of the dry mass column</span>
<span class="sd">            moisture_var: The name of the moisture column</span>
<span class="sd">            component_vars: The names of the chemical columns</span>
<span class="sd">            components_as_symbols: If True, convert the composition variables to symbols, e.g. Fe</span>
<span class="sd">            ranges: The range of valid data for each column in the data</span>
<span class="sd">            config_file: The configuration file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;./config/mc_config.yml&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">read_yaml</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">moisture_in_scope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mass_wet_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">mass_dry_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">moisture_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">component_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">component_vars</span>  <span class="c1"># TODO: check if this is redundant and remove.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;ppm&#39;</span><span class="p">,</span> <span class="s1">&#39;ppb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">composition_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">composition_factors</span><span class="p">[</span><span class="n">composition_units</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components_as_symbols</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">components_as_symbols</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># set the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># add the OOR status object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OutOfRangeStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranges</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="nd">@log_timer</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># convert chem mass to composition</span>
            <span class="n">mass_comp_data</span> <span class="o">=</span> <span class="n">mass_to_composition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">,</span>
                                                 <span class="n">mass_wet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">,</span> <span class="n">mass_dry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">,</span>
                                                 <span class="n">moisture_column_name</span><span class="o">=</span><span class="s1">&#39;H2O&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">components_as_symbols</span> <span class="k">else</span> <span class="p">(</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;h2o&#39;</span><span class="p">),</span>
                                                 <span class="n">component_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">,</span>
                                                 <span class="n">composition_units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_units</span><span class="p">)</span>

            <span class="c1"># append the supplementary vars</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mass_comp_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@data</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@log_timer</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Convert column names to symbols if components_as_symbols is True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">components_as_symbols</span><span class="p">:</span>
                <span class="n">symbol_dict</span> <span class="o">=</span> <span class="n">is_compositional</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">value</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">symbol_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

            <span class="c1"># the config provides regex search keys to detect mass and moisture columns if they are not specified.</span>
            <span class="n">mass_totals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_mass</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">composition</span><span class="p">,</span> <span class="n">supplementary_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_non_mass_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span> <span class="o">=</span> <span class="n">supplementary_data</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mass_data</span> <span class="o">=</span> <span class="n">composition_to_mass</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mass_totals</span><span class="p">,</span> <span class="n">composition</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                                 <span class="n">mass_wet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">,</span> <span class="n">mass_dry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">,</span>
                                                 <span class="n">moisture_column_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">moisture_column</span><span class="p">,</span>
                                                 <span class="n">component_columns</span><span class="o">=</span><span class="n">composition</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                                 <span class="n">composition_units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_units</span><span class="p">,</span>
                                                 <span class="n">return_moisture</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data has been set.&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mass_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span>

    <span class="nd">@mass_data</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mass_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Recalculate the aggregate whenever the data changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_average</span><span class="p">()</span>

<div class="viewcode-block" id="MassComposition.get_mass_data">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.get_mass_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_mass_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_moisture</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the mass data</span>

<span class="sd">        Args:</span>
<span class="sd">            include_moisture: If True (and moisture is in scope), include the moisture mass column</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">include_moisture</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span><span class="p">:</span>
            <span class="n">moisture_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">]</span>
            <span class="n">mass_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mass_data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">moisture_column</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">moisture_mass</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mass_data</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_average</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span>

    <span class="nd">@aggregate</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">variable_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A map from lower case standard names to the actual column names&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">existing_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span> <span class="ow">in</span> <span class="n">existing_columns</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;mass_wet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span> <span class="ow">in</span> <span class="n">existing_columns</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;mass_dry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;moisture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">components_as_symbols</span><span class="p">:</span>
                    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;moisture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_compositional</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span><span class="p">,</span>
                                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">:</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">col</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mass_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">existing_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span> <span class="ow">in</span> <span class="n">existing_columns</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span> <span class="ow">in</span> <span class="n">existing_columns</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">moisture_column</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;h2o&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">components_as_symbols</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">is_compositional</span><span class="p">([</span><span class="n">res</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">composition_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supplementary_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_columns</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">moisture_column</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">supplementary_columns</span><span class="p">)</span> <span class="k">if</span>
                <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

<div class="viewcode-block" id="MassComposition.balance_composition">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.balance_composition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">balance_composition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0e-6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MC</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Balance the composition data</span>

<span class="sd">        For records where the component mass exceeds the dry mass, the component masses are reduced proportionally</span>
<span class="sd">        to equal the dry mass.  Records where the component mass is less than the dry mass are left unchanged.</span>

<span class="sd">        epsilon: A small float to avoid component sums marginally over 100.0</span>

<span class="sd">        Returns:</span>
<span class="sd">            The object with balanced composition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># calculate the ratio of the sum of the components to the dry mass</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ratio</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span>

            <span class="n">before_reduction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># add a small value to the ratio to avoid component sums marginally over 100.0</span>
            <span class="n">ratio</span><span class="p">[</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">[</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span>
            <span class="c1"># to avoid reducing compliant records, clip the ratio at the lower side to 1.0</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="c1"># apply the ratio to the components</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># manage the reporting</span>
            <span class="n">affected_indexes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">before_reduction</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
            <span class="c1"># log the action, including the first 50 indexes affected</span>
            <span class="n">affected_indexes_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">affected_indexes</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_average</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OutOfRangeStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">ranges</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been balanced. &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">affected_indexes</span><span class="p">)</span><span class="si">}</span><span class="s2"> records where composition has been reduced &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;to conform to dry mass. &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;Affected indexes (first 50): </span><span class="si">{</span><span class="n">affected_indexes_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MassComposition.clip_recovery">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.clip_recovery">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clip_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">MC</span><span class="p">,</span> <span class="n">recovery_bounds</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">),</span>
                      <span class="n">allow_moisture_coercion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MC</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clip the recovery to the specified bounds and recalculate the estimate.</span>

<span class="sd">        Args:</span>
<span class="sd">            other: The other MassComposition object, from which the recovery of self is calculated.</span>
<span class="sd">            recovery_bounds: The bounds for the recovery between 0.0 and 1.0</span>
<span class="sd">            allow_moisture_coercion: if True, allow the wet mass to be modified to maintain the moisture (in the</span>
<span class="sd">            case that dry mass is clipped to manage recovery)</span>

<span class="sd">        Returns:</span>
<span class="sd">            The MassComposition object with the recovery clipped to the bounds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">recovery</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mass_data</span><span class="p">(</span><span class="n">include_moisture</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">/</span>
                                  <span class="n">other</span><span class="o">.</span><span class="n">get_mass_data</span><span class="p">(</span><span class="n">include_moisture</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="c1"># Limit the recovery to the bounds</span>
        <span class="n">before_clip</span> <span class="o">=</span> <span class="n">recovery</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">recovery</span> <span class="o">=</span> <span class="n">recovery</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">recovery_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">upper</span><span class="o">=</span><span class="n">recovery_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Check if any records were affected</span>
        <span class="n">affected_indexes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">recovery</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">before_clip</span> <span class="o">!=</span> <span class="n">recovery</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">affected_indexes</span><span class="p">:</span>
            <span class="c1"># Recalculate the estimate from the bound recovery</span>
            <span class="n">new_mass</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">recovery</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">get_mass_data</span><span class="p">(</span><span class="n">include_moisture</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="n">recovery</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span> <span class="ow">and</span> <span class="n">allow_moisture_coercion</span><span class="p">:</span>
                <span class="c1"># Calculate the moisture from the new mass</span>
                <span class="n">new_mass</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve_mass_moisture</span><span class="p">(</span><span class="n">mass_dry</span><span class="o">=</span><span class="n">new_mass</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">],</span>
                                                                  <span class="n">moisture</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">moisture_column</span><span class="p">])</span>

            <span class="c1"># Log the top 50 records affected by the recovery coercion</span>
            <span class="n">affected_indexes_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">affected_indexes</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recovery coercion affected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">affected_indexes</span><span class="p">)</span><span class="si">}</span><span class="s2"> records. &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;Affected indexes (first 50): </span><span class="si">{</span><span class="n">affected_indexes_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Update the mass data of self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_mass_data</span><span class="p">(</span><span class="n">new_mass</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recovery coercion did not affect any records.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MassComposition.set_moisture">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.set_moisture">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_moisture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moisture</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">mass_to_adjust</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;wet&#39;</span><span class="p">,</span> <span class="s1">&#39;dry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;wet&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MC</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the moisture to the specified value</span>

<span class="sd">        A convenience method for an mc object that modifies the concrete mass to deliver the specified moisture.</span>

<span class="sd">        Args:</span>
<span class="sd">            moisture: The moisture value to set.  Can be a constant or series.</span>
<span class="sd">            mass_to_adjust: The mass to adjust, either &#39;wet&#39; or &#39;dry&#39;.</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;This method is not applicable unless moisture_in_scope property is True.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moisture</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moisture</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># create a series with the same index as the mass data</span>
            <span class="n">moisture</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">moisture</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moisture</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;moisture must be a float or a pd.Series, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">moisture</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mass_to_adjust</span> <span class="o">==</span> <span class="s1">&#39;wet&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve_mass_moisture</span><span class="p">(</span><span class="n">mass_dry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">],</span>
                                                                     <span class="n">moisture</span><span class="o">=</span><span class="n">moisture</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mass_to_adjust</span> <span class="o">==</span> <span class="s1">&#39;dry&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve_mass_moisture</span><span class="p">(</span><span class="n">mass_wet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">],</span>
                                                                     <span class="n">moisture</span><span class="o">=</span><span class="n">moisture</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mass_to_adjust must be &#39;wet&#39; or &#39;dry&#39;, not </span><span class="si">{</span><span class="n">mass_to_adjust</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_average</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OutOfRangeStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">ranges</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MassComposition.clip_composition">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.clip_composition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clip_composition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranges</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0e-05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MC</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clip the components</span>

<span class="sd">        Clip to the components to within the range provided or the default range for each component.</span>
<span class="sd">        This method does not clip moisture - see set_moisture and solve_moisture for that.</span>

<span class="sd">        Args:</span>
<span class="sd">            ranges: An optional dict defining a list of [lo, hi] floats for each component.  If not provided,</span>
<span class="sd">            the default range from the config file will be used.</span>
<span class="sd">            epsilon: A small float to ensure the clipped values lie marginally inside the specified range.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The object with clipped composition.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># load the default ranges from the config file</span>
        <span class="n">component_ranges</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_component_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span>

        <span class="c1"># define a small value to ensure the clipped values lie marginally inside the specified range.</span>
        <span class="c1"># clip the components</span>
        <span class="n">affected_indexes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">component_range</span> <span class="ow">in</span> <span class="n">component_ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">before_clip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="n">component</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># add a small value to the range to ensure the clipped values lie marginally inside the specified range.</span>
            <span class="n">component_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">component_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">component_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">]</span>
            <span class="c1"># define the component mass that aligns with the lower and upper bounds</span>
            <span class="n">component_mass_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">component_range</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_factor</span>
            <span class="c1"># apply the clip to the mass data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="n">component</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="n">component_mass_limits</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                                                         <span class="n">upper</span><span class="o">=</span><span class="n">component_mass_limits</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">affected_indexes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">before_clip</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="n">component</span><span class="p">]])</span>

        <span class="c1"># log the action, including the first 50 indexes affected</span>
        <span class="n">affected_indexes_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">affected_indexes</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_average</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OutOfRangeStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">ranges</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">affected_indexes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been clipped. &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">affected_indexes</span><span class="p">)</span><span class="si">}</span><span class="s2"> records where composition has been clipped to the &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;range: </span><span class="si">{</span><span class="n">component_ranges</span><span class="si">}</span><span class="s2">. &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;Affected indexes (first 50): </span><span class="si">{</span><span class="n">affected_indexes_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="MassComposition.plot_parallel">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.plot_parallel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">vars_include</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">vars_exclude</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">include_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">plot_interval_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an interactive parallel plot</span>

<span class="sd">        Useful to explore multidimensional data like mass-composition data</span>

<span class="sd">        Args:</span>
<span class="sd">            color: Optional color variable</span>
<span class="sd">            vars_include: Optional list of variables to include in the plot</span>
<span class="sd">            vars_exclude: Optional list of variables to exclude in the plot</span>
<span class="sd">            title: Optional plot title</span>
<span class="sd">            include_dims: Optional boolean or list of dimension to include in the plot.  True will show all dims.</span>
<span class="sd">            plot_interval_edges: If True, interval edges will be plotted instead of interval mid</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">parallel_plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">vars_include</span><span class="o">=</span><span class="n">vars_include</span><span class="p">,</span> <span class="n">vars_exclude</span><span class="o">=</span><span class="n">vars_exclude</span><span class="p">,</span>
                            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                            <span class="n">include_dims</span><span class="o">=</span><span class="n">include_dims</span><span class="p">,</span> <span class="n">plot_interval_edges</span><span class="o">=</span><span class="n">plot_interval_edges</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="MassComposition.plot_comparison">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.plot_comparison">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">MC</span><span class="p">,</span>
                        <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">vars_include</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">vars_exclude</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">facet_col_wrap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="n">trendline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">trendline_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an interactive parallel plot</span>

<span class="sd">        Useful to compare the difference in component values between two objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            other: the object to compare with self.</span>
<span class="sd">            color: Optional color variable</span>
<span class="sd">            vars_include: Optional List of variables to include in the plot</span>
<span class="sd">            vars_exclude: Optional List of variables to exclude in the plot</span>
<span class="sd">            trendline: If True and trendlines</span>
<span class="sd">            trendline_kwargs: Allows customising the trendline: ref: https://plotly.com/python/linear-fits/</span>
<span class="sd">            title: Optional plot title</span>
<span class="sd">            facet_col_wrap: The number of subplot columns per row.</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_self</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="n">df_other</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">vars_include</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">missing_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vars_include</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_self</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;var_subset provided contains variable not found in the data: </span><span class="si">{</span><span class="n">missing_vars</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">df_self</span> <span class="o">=</span> <span class="n">df_self</span><span class="p">[</span><span class="n">vars_include</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vars_exclude</span><span class="p">:</span>
            <span class="n">df_self</span> <span class="o">=</span> <span class="n">df_self</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_self</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vars_exclude</span><span class="p">]]</span>
        <span class="n">df_other</span> <span class="o">=</span> <span class="n">df_other</span><span class="p">[</span><span class="n">df_self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="c1"># Supplementary variables are the same for each stream and so will be unstacked.</span>
        <span class="n">supp_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supplementary_columns</span>
        <span class="k">if</span> <span class="n">supp_cols</span><span class="p">:</span>
            <span class="n">df_self</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">supp_cols</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_other</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">supp_cols</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">index_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df_self</span> <span class="o">=</span> <span class="n">df_self</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="n">index_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">df_other</span> <span class="o">=</span> <span class="n">df_other</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="n">index_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

        <span class="n">df_plot</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_self</span><span class="p">,</span> <span class="n">df_other</span><span class="p">])</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">([</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_plot</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">index_names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># set variables back to standard order</span>
        <span class="n">variable_order</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">)}</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">variable_order</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">:</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span> <span class="o">=</span> <span class="n">comparison_plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_plot</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">facet_col_wrap</span><span class="o">=</span><span class="n">facet_col_wrap</span><span class="p">,</span>
                                         <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">trendline</span><span class="o">=</span><span class="n">trendline</span><span class="p">,</span> <span class="n">trendline_kwargs</span><span class="o">=</span><span class="n">trendline_kwargs</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="MassComposition.plot_ternary">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.plot_ternary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_ternary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot a ternary diagram</span>

<span class="sd">            variables: List of 3 components to plot</span>
<span class="sd">            color: Optional color variable</span>
<span class="sd">            title: Optional plot title</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">vars_missing</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vars_missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Variable/s not found in the dataset: </span><span class="si">{</span><span class="n">vars_missing</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">color</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_ternary</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> <span class="n">a</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_ternary</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> <span class="n">a</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">weight_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_by</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">group_by</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">composition</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_factor</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="n">mass_sum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># Recalculate the moisture</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span><span class="p">:</span>
                <span class="n">mass_sum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">moisture_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve_mass_moisture</span><span class="p">(</span><span class="n">mass_wet</span><span class="o">=</span><span class="n">mass_sum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                                                     <span class="n">mass_dry</span><span class="o">=</span><span class="n">mass_sum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

            <span class="c1"># Create a DataFrame from the weighted averages</span>
            <span class="n">weighted_averages_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mass_sum</span><span class="p">,</span> <span class="n">composition</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># group by a variable</span>
            <span class="n">group_var</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span><span class="p">[</span><span class="n">group_by</span><span class="p">]</span>
            <span class="n">weighted_averages_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_var</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_factor</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">weighted_averages_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">weighted_averages_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mass_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_columns</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_var</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">weighted_averages_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mass_sum</span><span class="p">,</span> <span class="n">weighted_averages_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span><span class="p">:</span>
                <span class="n">weighted_averages_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">moisture_column</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">solve_mass_moisture</span><span class="p">(</span>
                    <span class="n">mass_wet</span><span class="o">=</span><span class="n">mass_sum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                    <span class="n">mass_dry</span><span class="o">=</span><span class="n">mass_sum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>

        <span class="k">return</span> <span class="n">weighted_averages_df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_solve_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solve mass_wet and mass_dry from the provided columns.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: The input data with the column-names provided by the user\</span>

<span class="sd">        Returns: The mass data, with the columns mass_wet and mass_dry.  Only mass_dry if moisture_in_scope is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Auto-detect columns if they are not provided</span>
        <span class="n">mass_dry</span><span class="p">,</span> <span class="n">mass_wet</span><span class="p">,</span> <span class="n">moisture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_mass_moisture_columns</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mass_dry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mass_wet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">moisture</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve_mass_moisture</span><span class="p">(</span><span class="n">mass_wet</span><span class="o">=</span><span class="n">mass_wet</span><span class="p">,</span> <span class="n">moisture</span><span class="o">=</span><span class="n">moisture</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mass_dry_var is not provided and cannot be calculated from mass_wet_var and moisture_var &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_in_scope</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mass_wet</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mass_dry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">moisture</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve_mass_moisture</span><span class="p">(</span><span class="n">mass_dry</span><span class="o">=</span><span class="n">mass_dry</span><span class="p">,</span> <span class="n">moisture</span><span class="o">=</span><span class="n">moisture</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;mass_wet_var is not provided and cannot be calculated from mass_dry_var and moisture_var.  &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Consider specifying the mass_wet_var, mass_dry_var and moisture_var, or alternatively set &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;moisture_in_scope to False for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">moisture</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mass_wet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mass_dry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">solve_mass_moisture</span><span class="p">(</span><span class="n">mass_wet</span><span class="o">=</span><span class="n">mass_wet</span><span class="p">,</span> <span class="n">mass_dry</span><span class="o">=</span><span class="n">mass_dry</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;moisture_var is not provided and cannot be calculated from mass_wet_var and mass_dry_var.&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">mass_totals</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">value</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mass_totals</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">value</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">mass_totals</span>

        <span class="c1"># Helper method to extract column</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">var_type</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_type</span><span class="si">}</span><span class="s2">_var&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">][</span><span class="n">var_type</span><span class="p">][</span><span class="s1">&#39;search_regex&#39;</span><span class="p">],</span> <span class="n">col</span><span class="p">,</span>
                                  <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">][</span><span class="n">var_type</span><span class="p">][</span><span class="s1">&#39;default_name&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">var</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_mass_moisture_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_column</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;mass_wet&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_column</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;mass_dry&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_column</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;moisture&#39;</span><span class="p">)</span>
        <span class="n">mass_wet</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">)</span>
        <span class="n">mass_dry</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">)</span>
        <span class="n">moisture</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mass_dry</span><span class="p">,</span> <span class="n">mass_wet</span><span class="p">,</span> <span class="n">moisture</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_non_mass_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the composition data and supplementary data.  Extract only the composition columns specified,</span>
<span class="sd">        otherwise detect the compositional columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">composition</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">supplementary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">non_mass_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
                                            <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span><span class="p">,</span> <span class="s1">&#39;h2o&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;H2O&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">]]</span>
                <span class="n">component_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_components</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">non_mass_cols</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">component_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_vars</span>
            <span class="n">composition</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">component_cols</span><span class="p">]</span>

            <span class="n">supplementary_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
                                             <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">component_cols</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_wet_var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">,</span>
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">moisture_var</span><span class="p">,</span> <span class="s1">&#39;h2o&#39;</span><span class="p">,</span>
                                                                          <span class="s1">&#39;H2O&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">]]</span>
            <span class="n">supplementary</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">supplementary_cols</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">composition</span><span class="p">,</span> <span class="n">supplementary</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="c1"># Create a new instance of our class</span>
        <span class="n">new_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>
        <span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_obj</span>

        <span class="c1"># Copy each attribute</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new_obj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_mass_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>  <span class="c1"># if indexes have been dropped</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_average</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OutOfRangeStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">ranges</span><span class="p">)</span>

<div class="viewcode-block" id="MassComposition.filter_by_index">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.filter_by_index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_by_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the data by index&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_average</span><span class="p">()</span></div>


<div class="viewcode-block" id="MassComposition.split">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.split">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">fraction</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
              <span class="n">name_1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">name_2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">include_supplementary_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="s1">&#39;Stream&#39;</span><span class="p">,</span> <span class="s1">&#39;Stream&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split the object by mass</span>

<span class="sd">        A simple mass split maintaining the same composition</span>

<span class="sd">        Args:</span>
<span class="sd">            fraction: A constant in the range [0.0, 1.0]</span>
<span class="sd">            name_1: The name of the reference object created by the split</span>
<span class="sd">            name_2: The name of the complement object created by the split</span>
<span class="sd">            include_supplementary_data: Whether to inherit the supplementary variables</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple of two objects, the first with the mass fraction specified, the other the complement</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># create_congruent_objects to preserve properties like constraints</span>

        <span class="n">name_1</span> <span class="o">=</span> <span class="n">name_1</span> <span class="k">if</span> <span class="n">name_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_1&quot;</span>
        <span class="n">name_2</span> <span class="o">=</span> <span class="n">name_2</span> <span class="k">if</span> <span class="n">name_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_2&quot;</span>

        <span class="n">ref</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_congruent_object</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name_1</span><span class="p">,</span> <span class="n">include_mc_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">include_supp_data</span><span class="o">=</span><span class="n">include_supplementary_data</span><span class="p">)</span>
        <span class="n">ref</span><span class="o">.</span><span class="n">update_mass_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="o">*</span> <span class="n">fraction</span><span class="p">)</span>

        <span class="n">comp</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_congruent_object</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name_2</span><span class="p">,</span> <span class="n">include_mc_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                             <span class="n">include_supp_data</span><span class="o">=</span><span class="n">include_supplementary_data</span><span class="p">)</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">update_mass_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fraction</span><span class="p">))</span>

        <span class="c1"># Ensure self and other are Stream objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_stream</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_stream</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">:</span> <span class="s1">&#39;Stream&#39;</span>
        <span class="n">ref</span><span class="p">:</span> <span class="s1">&#39;Stream&#39;</span>
        <span class="n">comp</span><span class="p">:</span> <span class="s1">&#39;Stream&#39;</span>

        <span class="c1"># create the relationships</span>
        <span class="n">ref</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()]</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">ref</span><span class="p">,</span> <span class="n">comp</span></div>


<div class="viewcode-block" id="MassComposition.add">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.add">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">MC</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">include_supplementary_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Stream&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add two objects together</span>

<span class="sd">        Args:</span>
<span class="sd">            other: The other object</span>
<span class="sd">            name: The name of the new object</span>
<span class="sd">            include_supplementary_data: Whether to include the supplementary data</span>

<span class="sd">        Returns:</span>
<span class="sd">            The new object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">MC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_congruent_object</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">include_mc_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">include_supp_data</span><span class="o">=</span><span class="n">include_supplementary_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mass data columns do not match: </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> != &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">update_mass_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">)</span>

        <span class="c1"># Ensure self and other are Stream objects</span>
        <span class="bp">self</span><span class="p">:</span> <span class="s1">&#39;Stream&#39;</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_stream</span><span class="p">()</span>
        <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;Stream&#39;</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_stream</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">res</span><span class="p">:</span> <span class="s1">&#39;Stream&#39;</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_stream</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="c1"># create the relationships</span>
        <span class="n">other</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="MassComposition.sub">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.sub">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">MC</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">include_supplementary_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Stream&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtract other from self</span>

<span class="sd">        Args:</span>
<span class="sd">            other: The other object</span>
<span class="sd">            name: The name of the new object</span>
<span class="sd">            include_supplementary_data: Whether to include the supplementary data</span>

<span class="sd">        Returns:</span>
<span class="sd">            The new object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_congruent_object</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">include_mc_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">include_supp_data</span><span class="o">=</span><span class="n">include_supplementary_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mass data columns do not match: </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> != &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">res</span><span class="o">.</span><span class="n">update_mass_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">)</span>

        <span class="c1"># Ensure self and other are Stream objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_stream</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">:</span> <span class="s1">&#39;Stream&#39;</span>
        <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;Stream&#39;</span>

        <span class="c1"># create the relationships</span>
        <span class="n">other</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">other</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="MassComposition.div">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.div">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">MC</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">include_supplementary_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MC</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Divide two objects</span>

<span class="sd">        Divides self by other, with optional name of the returned object</span>
<span class="sd">        Args:</span>
<span class="sd">            other: the denominator (or reference) object</span>
<span class="sd">            name: name of the returned object</span>
<span class="sd">            include_supplementary_data: Whether to include the supplementary data</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_congruent_object</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">include_mc_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                               <span class="n">include_supp_data</span><span class="o">=</span><span class="n">include_supplementary_data</span><span class="p">)</span>
        <span class="n">new_obj</span><span class="o">.</span><span class="n">update_mass_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_obj</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="MassComposition.create_congruent_object">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.create_congruent_object">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_congruent_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">include_mc_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">include_supp_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MC</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an object with the same attributes&quot;&quot;&quot;</span>
        <span class="c1"># Create a new instance of our class</span>
        <span class="n">new_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>

        <span class="c1"># Copy each attribute</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;_mass_data&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">include_mc_data</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;_supplementary_data&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">include_supp_data</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="n">new_obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">return</span> <span class="n">new_obj</span></div>


<div class="viewcode-block" id="MassComposition.__add__">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.__add__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">MC</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Stream&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add two objects</span>

<span class="sd">        Perform the addition with the mass-composition variables only and then append any attribute variables.</span>
<span class="sd">        Presently ignores any attribute vars in other</span>
<span class="sd">        Args:</span>
<span class="sd">            other: object to add to self</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">include_supplementary_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">MC</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Stream&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtract the supplied object from self</span>

<span class="sd">        Perform the subtraction with the mass-composition variables only and then append any attribute variables.</span>
<span class="sd">        Args:</span>
<span class="sd">            other: object to subtract from self</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">include_supplementary_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Stream&#39;</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">elphick.geomet.flowsheet.stream</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stream</span>  <span class="c1"># Local import to avoid circular dependency</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Stream</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">Stream</span><span class="p">),</span> <span class="p">{})</span>
            <span class="n">filtered_kwargs</span> <span class="o">=</span> <span class="n">filter_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="n">filtered_kwargs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
            <span class="n">Stream</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">filtered_kwargs</span><span class="p">)</span>  <span class="c1"># Initialize Stream properties</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_to_stream</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Stream&#39;</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">elphick.geomet.flowsheet.stream</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stream</span>  <span class="c1"># Local import to avoid circular dependency</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Stream</span><span class="p">):</span>
            <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">Stream</span><span class="p">),</span> <span class="p">{})</span>
            <span class="n">filtered_kwargs</span> <span class="o">=</span> <span class="n">filter_kwargs</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="o">**</span><span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="n">filtered_kwargs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">data</span>
            <span class="n">Stream</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">filtered_kwargs</span><span class="p">)</span>  <span class="c1"># Initialize Stream properties</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">MC</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MC</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Divide self by the supplied object</span>

<span class="sd">        Perform the division with the mass-composition variables only and then append any attribute variables.</span>
<span class="sd">        Args:</span>
<span class="sd">            other: denominator object, self will be divided by this object</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">include_supplementary_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MassComposition</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="MassComposition.from_mass_dataframe">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.from_mass_dataframe">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_mass_dataframe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mass_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                            <span class="n">mass_wet</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mass_wet&#39;</span><span class="p">,</span>
                            <span class="n">mass_dry</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mass_dry&#39;</span><span class="p">,</span>
                            <span class="n">moisture_column_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">component_columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">composition_units</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;ppm&#39;</span><span class="p">,</span> <span class="s1">&#39;ppb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MC</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to create a MassComposition object from a mass dataframe.</span>

<span class="sd">        Args:</span>
<span class="sd">            mass_df: DataFrame with mass data.</span>
<span class="sd">            **kwargs: Additional arguments to pass to the MassComposition constructor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new MassComposition object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert mass to composition using the function from the pandas module</span>
        <span class="n">composition_df</span> <span class="o">=</span> <span class="n">mass_to_composition</span><span class="p">(</span><span class="n">mass_df</span><span class="p">,</span> <span class="n">mass_wet</span><span class="o">=</span><span class="n">mass_wet</span><span class="p">,</span> <span class="n">mass_dry</span><span class="o">=</span><span class="n">mass_dry</span><span class="p">,</span>
                                             <span class="n">moisture_column_name</span><span class="o">=</span><span class="n">moisture_column_name</span><span class="p">,</span>
                                             <span class="n">component_columns</span><span class="o">=</span><span class="n">component_columns</span><span class="p">,</span>
                                             <span class="n">composition_units</span><span class="o">=</span><span class="n">composition_units</span><span class="p">)</span>

        <span class="c1"># Create a new instance of the MassComposition class</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">composition_df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="MassComposition.query">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.MassComposition.html#elphick.geomet.base.MassComposition.query">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MC</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reduce the data by a query expression</span>

<span class="sd">        Args:</span>
<span class="sd">            expr: A pandas query expression</span>
<span class="sd">            name: name of the new object</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new object with the reduced data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_congruent_object</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">include_mc_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">include_supp_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">filtered_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
        <span class="n">res</span><span class="o">.</span><span class="n">update_mass_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filtered_index</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">supplementary_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">_supplementary_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filtered_index</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">res</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">,</span> <span class="n">comparisons</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;recovery&#39;</span><span class="p">,</span>
                <span class="n">explicit_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>

        <span class="n">comparisons</span> <span class="o">=</span> <span class="p">[</span><span class="n">comparisons</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comparisons</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">comparisons</span>
        <span class="n">valid_comparisons</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;recovery&#39;</span><span class="p">,</span> <span class="s1">&#39;difference&#39;</span><span class="p">,</span> <span class="s1">&#39;divide&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">}</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_attrs</span><span class="p">]</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;recovery&#39;</span> <span class="ow">in</span> <span class="n">comparisons</span> <span class="ow">or</span> <span class="n">comparisons</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">component_vars</span><span class="p">]</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">component_vars</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">explicit_names</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;comparisons&#39;</span><span class="p">][</span><span class="s1">&#39;recovery&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>
                              <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;difference&#39;</span> <span class="ow">in</span> <span class="n">comparisons</span> <span class="ow">or</span> <span class="n">comparisons</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">explicit_names</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;comparisons&#39;</span><span class="p">][</span><span class="s1">&#39;difference&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>
                              <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;divide&#39;</span> <span class="ow">in</span> <span class="n">comparisons</span> <span class="ow">or</span> <span class="n">comparisons</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">explicit_names</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;comparisons&#39;</span><span class="p">][</span><span class="s1">&#39;divide&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>
                              <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The comparison argument is not valid: </span><span class="si">{</span><span class="n">valid_comparisons</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MC</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_congruent_object</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (reset_index)&quot;</span><span class="p">,</span> <span class="n">include_mc_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">include_supp_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">update_mass_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">supplementary_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">_supplementary_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_supplementary_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">_supplementary_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">index_name</span><span class="p">],</span>
                                                   <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mass_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="n">index_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_component_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranges</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>

        <span class="n">d_ranges</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">get_column_config</span><span class="p">(</span><span class="n">config_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">var_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">variable_map</span><span class="p">,</span>
                                           <span class="n">config_key</span><span class="o">=</span><span class="s1">&#39;range&#39;</span><span class="p">)</span>
        <span class="c1"># filter to include only components</span>
        <span class="n">d_ranges</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d_ranges</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">}</span>

        <span class="c1"># modify the default dict based on any user passed constraints</span>
        <span class="k">if</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">d_ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="n">d_ranges</span></div>



<div class="viewcode-block" id="OutOfRangeStatus">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.OutOfRangeStatus.html#elphick.geomet.base.OutOfRangeStatus">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OutOfRangeStatus</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to check and report out-of-range records in an MC object.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="OutOfRangeStatus.__init__">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.OutOfRangeStatus.html#elphick.geomet.base.OutOfRangeStatus.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mc</span><span class="p">:</span> <span class="s1">&#39;MC&#39;</span><span class="p">,</span> <span class="n">ranges</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize with an MC object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="p">:</span> <span class="s1">&#39;MC&#39;</span> <span class="o">=</span> <span class="n">mc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_oor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failing_components</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">mc</span><span class="o">.</span><span class="n">mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ranges</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oor</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_range</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_oor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oor</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failing_components</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oor</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_oor</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranges</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>

        <span class="n">d_ranges</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">get_column_config</span><span class="p">(</span><span class="n">config_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">var_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">variable_map</span><span class="p">,</span>
                                           <span class="n">config_key</span><span class="o">=</span><span class="s1">&#39;range&#39;</span><span class="p">)</span>

        <span class="c1"># modify the default dict based on any user passed constraints</span>
        <span class="k">if</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">d_ranges</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="n">d_ranges</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_range</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if all records are within the constraints.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">_mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">bounds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">variable</span><span class="p">])</span>
            <span class="n">oor</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># An empty object will have ok status</span>
            <span class="n">oor</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ranges</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">oor</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ok</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if all records are within range, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_oor</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_oor</span><span class="si">}</span><span class="s1"> out of range records exist.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_oor</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation of the status.&quot;&quot;&quot;</span>
        <span class="n">res</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;status.ok: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;num_oor: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_oor</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if other Status has the same out-of-range records.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">OutOfRangeStatus</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">oor</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">oor</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="SampleStatus">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.SampleStatus.html#elphick.geomet.base.SampleStatus">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SampleStatus</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to check and report sample status in an MC object.</span>

<span class="sd">    A MassComposition object (Sample, Stream, etc) can be unhealthy if:</span>
<span class="sd">    1. the total mass of components is greater than the dry mass</span>
<span class="sd">    2. any of the masses are negative</span>
<span class="sd">    3. the component values are out of range</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SampleStatus.__init__">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.SampleStatus.html#elphick.geomet.base.SampleStatus.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mc</span><span class="p">:</span> <span class="s1">&#39;MC&#39;</span><span class="p">,</span> <span class="n">component_limits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize with an MC object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="p">:</span> <span class="s1">&#39;MC&#39;</span> <span class="o">=</span> <span class="n">mc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failing_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">mc</span><span class="o">.</span><span class="n">mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sample_status</span><span class="p">(</span><span class="n">component_limits</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_status</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failing_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample</span> <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_status</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;ok&#39;</span><span class="p">]]</span></div>


<div class="viewcode-block" id="SampleStatus.get_sample_status">
<a class="viewcode-back" href="../../../api/_autosummary/elphick.geomet.base.SampleStatus.html#elphick.geomet.base.SampleStatus.get_sample_status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_sample_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_limits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if all records are within the constraints.&quot;&quot;&quot;</span>
        <span class="n">sample_status</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">_mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">composition_columns</span><span class="p">]</span>
            <span class="n">mass_dry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">_mass_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mass_dry_var</span><span class="p">]</span>

            <span class="c1"># Check for component limits</span>
            <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">limits</span> <span class="ow">in</span> <span class="n">component_limits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">oor</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">oor</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample_status</span><span class="p">:</span>
                        <span class="n">sample_status</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ok&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;causes&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="n">sample_status</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="s1">&#39;ok&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">sample_status</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="s1">&#39;causes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2"> out of range&quot;</span><span class="p">)</span>

            <span class="c1"># Check if total mass of components is greater than dry mass</span>
            <span class="n">total_component_mass</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">total_component_mass</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample_status</span><span class="p">:</span>
                    <span class="n">sample_status</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ok&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;causes&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">if</span> <span class="n">total_component_mass</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mass_dry</span><span class="p">[</span><span class="n">sample</span><span class="p">]:</span>
                    <span class="n">sample_status</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="s1">&#39;ok&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">sample_status</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="s1">&#39;causes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Total mass of components greater than dry mass&quot;</span><span class="p">)</span>

            <span class="c1"># Check for negative masses</span>
            <span class="n">negative_masses</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">negative_masses</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample_status</span><span class="p">:</span>
                    <span class="n">sample_status</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ok&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;causes&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="n">sample_status</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="s1">&#39;ok&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">sample_status</span><span class="p">[</span><span class="n">sample</span><span class="p">][</span><span class="s1">&#39;causes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Negative mass detected&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample_status</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ok</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if all records are within range, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="si">}</span><span class="s1"> unhealthy samples exist.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation of the status.&quot;&quot;&quot;</span>
        <span class="n">res</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;status.ok: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ok</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;num_samples: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if other Status has the same out-of-range records.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SampleStatus</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_status</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">sample_status</span>
        <span class="k">return</span> <span class="kc">False</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Greg Elphick.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>